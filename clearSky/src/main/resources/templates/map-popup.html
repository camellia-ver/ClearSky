<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>지도 선택</title>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #popup-map {
            width: 100vw;   /* 뷰포트 전체 너비 */
            height: 100vh;  /* 뷰포트 전체 높이 */
            background-color: rgba(255,0,0,0.2);
        }
    </style>
</head>
<body>
<div id="popup-map"></div>

<script th:src="@{'https://dapi.kakao.com/v2/maps/sdk.js?appkey=' + ${kakaoKey} + '&libraries=services'}"></script>
<script>
    // DOM이 완전히 로드된 후 실행
    document.addEventListener("DOMContentLoaded", function() {
        if (typeof kakao !== 'undefined') {
            console.log("Kakao Maps SDK 로드 성공");
            initMap();
        } else {
            console.error("Kakao Maps SDK 로드 실패");
        }
    });

    function initMap() {
        const container = document.getElementById('popup-map');
        if (!container) {
            console.error("#popup-map 요소를 찾을 수 없습니다.");
            return;
        }

        // 지도 초기 위치: 서울
        const defaultCenter = new kakao.maps.LatLng(37.5665, 126.9780);
        const map = new kakao.maps.Map(container, {
            center: defaultCenter,
            level: 3
        });

        const geocoder = new kakao.maps.services.Geocoder();
        let marker = null;

        // 지도 클릭 시 마커 표시 및 좌표 → 주소 변환
        kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
            const lat = mouseEvent.latLng.getLat();
            const lng = mouseEvent.latLng.getLng();

            if (marker) marker.setMap(null);
            marker = new kakao.maps.Marker({ position: mouseEvent.latLng });
            marker.setMap(map);

            geocoder.coord2Address(lng, lat, function(result, status) {
                if (status === kakao.maps.services.Status.OK) {
                    const address = result[0].address;

                    // 부모 창의 input에 값 넣기
                    if (window.opener) {
                        window.opener.document.getElementById('level1-input').value = address.region_1depth_name;
                        window.opener.document.getElementById('level2-input').value = address.region_2depth_name;
                        window.opener.document.getElementById('level3-input').value = address.region_3depth_name;

                        // 선택 후 팝업 닫기
                        window.close();
                    }
                }
            });
        });
    }
</script>
</body>
</html>
